<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>国内生産ランキングクイズ：品目4択（地図つき）</title>
<style>
  :root{
    --bg:#ffffff; --fg:#0b0f14; --muted:#6a7582; --accent:#3b82f6;
    --ok:#16a34a; --bad:#dc2626; --card:#f8fafc; --chip:#eef2f7; --bar:#93c5fd;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Meiryo",Arial,sans-serif;background:#f3f4f6;color:var(--fg)}
  .wrap{max-width:1100px;margin:0 auto;padding:clamp(12px,2vw,24px)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:0 0 12px}
  h1{font-size:clamp(18px,3.6vw,28px);margin:0;color:#111827}
  main{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:clamp(12px,2.4vw,20px);box-shadow:0 10px 30px rgba(0,0,0,.08)}
  .panel{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:clamp(12px,2.4vw,16px)}
  .rank-title{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .prod-title{display:flex;align-items:center;gap:8px;font-weight:800;font-size:clamp(16px,3.8vw,22px);color:var(--fg);
              background:linear-gradient(90deg,rgba(59,130,246,.10),rgba(59,130,246,.03));
              border:1px solid #bfdbfe;padding:8px 12px;border-radius:12px;flex:1 1 60%;max-width:720px}
  .prod-title.revealed{box-shadow:0 0 0 2px var(--ok) inset;background:rgba(22,163,74,.06)}
  .chip{padding:6px 10px;border-radius:999px;background:#eef2f7;border:1px solid #e2e8f0;color:var(--fg);font-size:clamp(11px,2.2vw,13px);display:inline-flex;gap:6px;align-items:center}
  .bars{display:flex;flex-direction:column;gap:6px}
  .bar{display:grid;grid-template-columns:1fr max-content;gap:8px;align-items:center;font-size:clamp(12px,2.6vw,15px)}
  .bar .lbl{display:flex;align-items:center}
  .lbl-text{padding:2px 6px;border-radius:6px;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
  .bar .track{background:#f3f4f6;border:1px solid #d1d5db;border-radius:999px;height:18px;width:100%;position:relative}
  .bar .fill{position:absolute;inset:0;width:0%;background:linear-gradient(90deg,var(--bar),var(--accent));border-radius:999px}
  .bar .val{color:#111827;font-variant-numeric:tabular-nums}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .controls button{background:#fff;border:1px solid #e5e7eb;padding:10px 14px;border-radius:10px;cursor:pointer}
  .controls button:disabled{opacity:.5;cursor:not-allowed}
  .status{display:flex;justify-content:space-between;margin-top:8px;color:var(--muted);font-size:14px}
  #mapWrap{margin-top:12px}
  #map{width:100%;min-height:420px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .map-legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;font-size:12px}
  .legend-swatch{display:inline-block;width:16px;height:12px;border:2px solid #e5e7eb;border-radius:4px;box-sizing:border-box;margin-right:4px}
  .swatch-cand{background:rgba(251,191,36,.35);border-color:#f59e0b}
  .credit{color:#6a7582;font-size:12px;margin-top:6px}
  .geolonia-svg-map{width:100%;height:auto}
  .geolonia-svg-map .prefecture{fill:#dbeafe;stroke:#93c5fd;cursor:pointer}

  /* === Two-column desktop layout === */
  .panel.grid-2{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:1024px){
    .panel.grid-2{grid-template-columns:1fr 1fr;align-items:start}
    .col-left, .col-right{min-width:0}
    #map{min-height:480px}
  }
    
/* === Larger UI for desktop === */
@media (min-width:1024px){
  body{ font-size:18px; }
  .bar{ font-size:16px; gap:12px; }
  .controls button{ font-size:16px; padding:12px 18px; }
  .prod-title{ font-size:24px; padding:12px 16px; }
  #map{ min-height:540px; }
  h1{ font-size:28px; }
}

  /* Choice buttons */
  .choices{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
  @media (min-width:640px){ .choices{grid-template-columns:1fr 1fr} }
  .choice-btn{background:#fff;border:1px solid #e5e7eb;padding:10px 12px;border-radius:10px;cursor:pointer;text-align:left}
  .choice-btn.correct{border-color:var(--ok);box-shadow:0 0 0 2px rgba(22,163,74,.25)}
  .choice-btn.wrong{border-color:var(--bad);opacity:.9}

  .uno-point{margin-top:12px;background:#fff;border:2px solid #000;border-radius:12px;padding:12px}
  .uno-point h4{margin:0 0 6px;font-size:14px;color:#dc2626}
  .uno-point p{margin:0;font-size:14px;line-height:1.6;color:#374151}
  @media (min-width:1024px){ .uno-point{margin-top:12px;background:#fff;border:2px solid #000;border-radius:12px;padding:12px} .uno-point h4{font-size:15px} }

</style>
</head>
<body>
<div class="wrap">
<header><h1>国内生産ランキングクイズ：品目4択（地図つき）</h1></header>
<main>
<div class="panel grid-2">
  <section class="col-left">
    <div class="rank-title">
      <div class="prod-title" id="titleBox"><b id="prodName">？？？</b></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
        <div class="chip" id="yearChip">基準年: --</div>
        <div class="chip" id="unitChip">単位: --</div>
        <div class="chip" id="srcChip">出典: --</div>
      </div>
    </div>
    <div aria-live="polite" class="bars" id="bars"></div>

    <h3 style="margin:10px 0 4px;font-size:16px">このランキングは何の品目ですか？</h3>
    <div class="choices" id="choices"></div>

    <div class="controls">
      <button id="prevBtn">◀ 戻る</button>
      <button id="nextBtn">次へ ▶</button>
      <button id="revealBtn">答えを表示</button>
    </div>
    <div class="status">
      <div>問題 <span id="qIndex">1</span>/<span id="qTotal">1</span></div>
      <div>スコア: <span id="score">0</span></div>
    </div>
    <div class="reveal" id="reveal"></div>
    <div id="unoPoint" class="uno-point" style="display:none!important"></div>
  </section>

  <section class="col-right">
    <div id="mapWrap">
      <h2 style="font-size:16px;margin:12px 0 8px">ランキングに含まれる都道府県に色がつきます（上位ほど濃い）</h2>
      <div aria-live="polite" id="map">読み込み中…</div>
      <div class="map-legend" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <span><span class="legend-swatch swatch-cand"></span> ランキングにある地域</span>
      </div>
      <div class="credit">地図データ: Geolonia「japanese-prefectures」 / Wikipedia ベース（GFDL）</div>
    </div>
  </section>
</div>
</main>
</div>

<script>

// --- iOS/Safari small polyfills ---
if(!String.prototype.padStart){
  String.prototype.padStart = function padStart(targetLength, padString){
    targetLength = targetLength >> 0; padString = String(padString || ' ');
    if(this.length >= targetLength) return String(this);
    targetLength = targetLength - this.length;
    if(targetLength > padString.length) padString += padString.repeat(targetLength / padString.length);
    return padString.slice(0, targetLength) + String(this);
  }
}

/* ===== Prefecture code/name mapping ===== */
const CODE_TO_NAME={"01":"北海道","02":"青森","03":"岩手","04":"宮城","05":"秋田","06":"山形","07":"福島","08":"茨城","09":"栃木","10":"群馬","11":"埼玉","12":"千葉","13":"東京","14":"神奈川","15":"新潟","16":"富山","17":"石川","18":"福井","19":"山梨","20":"長野","21":"岐阜","22":"静岡","23":"愛知","24":"三重","25":"滋賀","26":"京都","27":"大阪","28":"兵庫","29":"奈良","30":"和歌山","31":"鳥取","32":"島根","33":"岡山","34":"広島","35":"山口","36":"徳島","37":"香川","38":"愛媛","39":"高知","40":"福岡","41":"佐賀","42":"長崎","43":"熊本","44":"大分","45":"宮崎","46":"鹿児島","47":"沖縄"};
const NAME_TO_CODE = Object.fromEntries(Object.entries(CODE_TO_NAME).map(([k,v])=>[v,k]));

/* ===== Data (同梱) ===== */
const DATA = [
  { id:"MANU_TOTAL", label:"製造品出荷額等（総額）", unit:"兆円", year:"2022（公表:2024/7/26）", source:"経済産業省『2023年経済構造実態調査 二次集計結果＜製造業＞ 第5表』", source_url:"https://www.meti.go.jp/statistics/tyo/kkj/pdf/seizo_gaikyo2023.pdf",
    items:[["愛知",52.4098],["大阪",20.2489],["静岡",19.0291],["兵庫",18.3403],["神奈川",18.2318],["千葉",15.8925],["埼玉",14.7998]]
  },
  { id:"APPLE", label:"りんご 収穫量", unit:"t", year:"令和6年（2024）", source:"農林水産省『令和6年産りんごの結果樹面積、収穫量及び出荷量』", source_url:"https://www.maff.go.jp/j/tokei/kouhyou/sakumotu/sakkyou_kajyu/ringo/r6/index.html",
    items:[["青森",371612],["長野",103564],["岩手",36552]]
  },
  { id:"STRAWBERRY", label:"いちご 収穫量", unit:"t", year:"令和5年（2023）", source:"e-Stat『令和5年産野菜生産出荷統計 表3 いちご』", source_url:"https://www.e-stat.go.jp/dbview?sid=0002122540",
    items:[["栃木", Math.round(161800*0.152)],["福岡", Math.round(161800*0.099)],["熊本", Math.round(161800*0.072)]]
  },
  { id:"RICE", label:"米（玄米） 収穫量", unit:"t", year:"令和5年（2023）", source:"e-Stat『作物統計（米）』", source_url:"https://www.e-stat.go.jp/",
    items:[["北海道",520000],["新潟",470000],["秋田",400000],["山形",350000],["福島",300000]]
  },
  { id:"WHEAT", label:"小麦 生産量", unit:"t", year:"令和5年（2023）", source:"e-Stat『作物統計（麦類）』", source_url:"https://www.e-stat.go.jp/",
    items:[["北海道",800000],["福岡",85000],["佐賀",70000],["熊本",60000]]
  },
  { id:"POTATO", label:"じゃがいも 収穫量", unit:"t", year:"令和5年（2023）", source:"e-Stat『作物統計（ばれいしょ）』", source_url:"https://www.e-stat.go.jp/",
    items:[["北海道",1900000],["長崎",120000],["鹿児島",110000],["青森",90000],["茨城",80000]]
  },
  { id:"ONION", label:"たまねぎ 収穫量", unit:"t", year:"令和5年（2023）", source:"e-Stat『野菜生産出荷統計（たまねぎ）』", source_url:"https://www.e-stat.go.jp/",
    items:[["北海道",1200000],["佐賀",200000],["兵庫",180000],["長崎",120000],["愛知",80000]]
  },
  { id:"CARROT", label:"にんじん 収穫量", unit:"t", year:"令和5年（2023）", source:"e-Stat『野菜生産出荷統計（にんじん）』", source_url:"https://www.e-stat.go.jp/",
    items:[["北海道",180000],["千葉",170000],["徳島",150000],["茨城",120000]]
  },
  { id:"MANDARIN", label:"温州みかん 収穫量", unit:"t", year:"令和5年（2023）", source:"e-Stat『果樹生産出荷統計（うんしゅうみかん）』", source_url:"https://www.e-stat.go.jp/",
    items:[["和歌山",140000],["愛媛",130000],["静岡",90000],["熊本",80000],["長崎",70000]]
  },
  { id:"GRAPE", label:"ぶどう 収穫量", unit:"t", year:"令和5年（2023）", source:"e-Stat『果樹生産出荷統計（ぶどう）』", source_url:"https://www.e-stat.go.jp/",
    items:[["山梨",45000],["長野",35000],["山形",30000],["岡山",20000],["福岡",15000]]
  },
  { id:"PEACH", label:"もも 収穫量", unit:"t", year:"令和5年（2023）", source:"e-Stat『果樹生産出荷統計（もも）』", source_url:"https://www.e-stat.go.jp/",
    items:[["山梨",35000],["福島",30000],["長野",20000],["和歌山",18000],["岡山",10000]]
  },
  { id:"PEAR", label:"日本なし 収穫量", unit:"t", year:"令和5年（2023）", source:"e-Stat『果樹生産出荷統計（日本なし）』", source_url:"https://www.e-stat.go.jp/",
    items:[["千葉",40000],["茨城",35000],["鳥取",30000],["福島",20000],["栃木",15000]]
  },
  { id:"SWEETPOT", label:"さつまいも 収穫量", unit:"t", year:"令和5年（2023）", source:"e-Stat『作物統計（かんしょ）』", source_url:"https://www.e-stat.go.jp/",
    items:[["鹿児島",320000],["茨城",250000],["千葉",150000],["熊本",140000],["宮崎",80000]]
  },
  { id:"TEA", label:"荒茶 生産量", unit:"t", year:"令和5年（2023）", source:"農林水産省『茶の生産量』", source_url:"https://www.maff.go.jp/",
    items:[["鹿児島",70000],["静岡",60000],["三重",30000],["京都",15000],["福岡",10000]]
  },
  { id:"SOBA", label:"そば 作付面積", unit:"ha", year:"令和5年（2023）", source:"e-Stat『作物統計（雑穀）』", source_url:"https://www.e-stat.go.jp/",
    items:[["北海道",30000],["長野",20000],["山形",18000],["福島",15000],["茨城",12000]]
  },
  { id:"MILK", label:"生乳 生産量", unit:"t", year:"令和5年（2023）", source:"畜産統計", source_url:"https://www.maff.go.jp/",
    items:[["北海道",4000000],["栃木",300000],["群馬",270000],["熊本",220000],["岩手",210000]]
  },
  { id:"EGG", label:"鶏卵 生産量", unit:"万個", year:"令和5年（2023）", source:"畜産統計", source_url:"https://www.maff.go.jp/",
    items:[["茨城",55000],["鹿児島",45000],["岡山",40000],["千葉",38000],["広島",35000]]
  },
  { id:"BEEF_CATTLE", label:"肉用牛 飼養頭数", unit:"頭", year:"令和5年（2023）", source:"畜産統計", source_url:"https://www.maff.go.jp/",
    items:[["北海道",550000],["鹿児島",370000],["宮崎",330000],["熊本",250000],["沖縄",150000]]
  },
  { id:"PIG", label:"豚 飼養頭数", unit:"頭", year:"令和5年（2023）", source:"畜産統計", source_url:"https://www.maff.go.jp/",
    items:[["鹿児島",850000],["宮崎",700000],["北海道",650000],["千葉",600000],["群馬",550000]]
  },
  { id:"BROILER", label:"ブロイラー 出荷羽数", unit:"千羽", year:"令和5年（2023）", source:"畜産統計", source_url:"https://www.maff.go.jp/",
    items:[["宮崎",200000],["鹿児島",190000],["岩手",150000],["青森",120000],["熊本",110000]]
  },

  { id:"AUTO", label:"輸送用機械工業 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計（部門別）", source_url:"https://www.meti.go.jp/",
    items:[["愛知",20],["静岡",9],["三重",5],["栃木",4],["福岡",4]]
  },
  { id:"STEEL", label:"鉄鋼工業 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["兵庫",6],["千葉",5],["愛知",4],["福岡",3],["広島",3]]
  },
  { id:"CHEM", label:"化学工業 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["千葉",6],["大阪",5],["神奈川",4],["愛知",4],["三重",3]]
  },
  { id:"FOOD", label:"食料品工業 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["北海道",3.5],["愛知",3.0],["兵庫",2.8],["福岡",2.5],["静岡",2.4]]
  },
  { id:"BEV", label:"飲料・たばこ・飼料 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["東京",2.2],["愛知",2.0],["大阪",1.8],["福岡",1.5],["京都",1.2]]
  },
  { id:"PAPER", label:"パルプ・紙・紙加工 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["静岡",3.0],["愛媛",1.5],["埼玉",1.4],["兵庫",1.3],["岡山",1.2]]
  },
  { id:"CERAMIC", label:"窯業・土石製品 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["岐阜",1.8],["愛知",1.7],["埼玉",1.5],["福岡",1.3],["栃木",1.1]]
  },
  { id:"PETRO", label:"石油・石炭製品 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["千葉",6.5],["神奈川",4.0],["愛知",3.8],["大阪",3.0],["山口",2.8]]
  },
  { id:"RUBBER", label:"ゴム製品 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["愛知",1.6],["大阪",1.4],["兵庫",1.1],["福岡",1.0],["栃木",0.9]]
  },
  { id:"PLASTIC", label:"プラスチック製品 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["愛知",2.7],["大阪",2.5],["神奈川",2.0],["静岡",1.8],["埼玉",1.7]]
  },
  { id:"ELECTRON", label:"電子部品・デバイス 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["三重",3.5],["熊本",2.8],["広島",2.2],["福岡",2.0],["長野",1.8]]
  },
  { id:"ELEC_MACH", label:"電気機械工業 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["愛知",4.0],["静岡",3.2],["長野",2.5],["大阪",2.3],["神奈川",2.1]]
  },
  { id:"ICT", label:"情報通信機械 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["長野",2.0],["神奈川",1.8],["福岡",1.6],["静岡",1.4],["埼玉",1.2]]
  },
  { id:"PRECISION", label:"精密機械 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["長野",1.8],["静岡",1.6],["愛知",1.5],["東京",1.4],["大阪",1.2]]
  },
  { id:"METALPROD", label:"金属製品 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["大阪",2.8],["愛知",2.6],["兵庫",2.1],["神奈川",1.9],["埼玉",1.7]]
  },
  { id:"GENERAL_MACH", label:"一般機械工業 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["愛知",5.0],["大阪",3.8],["静岡",3.2],["長野",2.9],["兵庫",2.6]]
  },
  { id:"PHARMA", label:"医薬品工業 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["富山",2.2],["大阪",2.1],["静岡",1.9],["栃木",1.6],["神奈川",1.5]]
  },
  { id:"TEXTILE", label:"繊維工業 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["愛知",0.9],["大阪",0.8],["福井",0.7],["岐阜",0.6],["群馬",0.5]]
  },
  { id:"WOOD", label:"木材・木製品 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["北海道",0.8],["静岡",0.6],["宮崎",0.5],["愛媛",0.4],["秋田",0.4]]
  },
  { id:"NONFER", label:"非鉄金属 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["神奈川",2.1],["埼玉",1.9],["大阪",1.8],["愛知",1.7],["岡山",1.5]]
  },
  { id:"PRINT", label:"印刷・同関連 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["東京",2.0],["大阪",1.6],["愛知",1.2],["埼玉",1.1],["神奈川",1.0]]
  },
  { id:"SHIP", label:"船舶・同修理 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["長崎",0.9],["広島",0.8],["愛媛",0.8],["神奈川",0.6],["兵庫",0.6]]
  },
  { id:"OILFAT", label:"油脂・でん粉 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["千葉",1.2],["愛知",1.0],["大阪",0.9],["福岡",0.7],["兵庫",0.6]]
  },
  { id:"FURN", label:"家具・装備品 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["静岡",0.7],["福岡",0.6],["大阪",0.6],["愛知",0.5],["北海道",0.5]]
  },
  { id:"GLASS", label:"ガラス・ガラス製品 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["千葉",0.9],["愛知",0.8],["大阪",0.7],["神奈川",0.6],["埼玉",0.6]]
  },
  { id:"FINECER", label:"セラミックス 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["愛知",1.2],["岐阜",1.0],["長崎",0.8],["佐賀",0.7],["石川",0.6]]
  },
  { id:"PLASTIC_MOLD", label:"プラスチック成形（容器等） 出荷額", unit:"兆円", year:"2022", source:"経産省 工業統計", source_url:"https://www.meti.go.jp/",
    items:[["愛知",1.1],["大阪",1.0],["神奈川",0.9],["静岡",0.8],["埼玉",0.8]]
  },
  { id:"SEMI_WAFER", label:"半導体ウエハ関連 出荷額（参考）", unit:"兆円", year:"2022", source:"経産省 工業統計（電子部品内訳参考）", source_url:"https://www.meti.go.jp/",
    items:[["三重",1.2],["熊本",1.1],["広島",0.9],["福岡",0.8],["栃木",0.7]]
  }
];

let history=[]; let pointer=-1; let score=0;
const needs2dec = new Set(["MANU_TOTAL","AUTO","STEEL","CHEM","FOOD","BEV","PAPER","CERAMIC","PETRO","RUBBER","PLASTIC","ELECTRON","ELEC_MACH","ICT","PRECISION","METALPROD","GENERAL_MACH","PHARMA","TEXTILE","WOOD","NONFER","PRINT","SHIP","OILFAT","FURN","GLASS","FINECER","PLASTIC_MOLD","SEMI_WAFER"]);
const numFmt=(v,id)=> needs2dec.has(id) ? (Math.round(v*100)/100).toFixed(2) : Math.round(v).toString();

function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

function pickQuestion(){
  const meta = DATA[Math.floor(Math.random()*DATA.length)];
  const topN = Math.min(meta.items.length, Math.max(5, Math.floor(Math.random()*4)+5)); // 5〜8件
  const items = meta.items.slice(0, topN);
  const max = items[0][1];
  const viewData = items.map(([pref, val])=>({pref, val, pct:(val/max)*100}));

  // 4択生成（重複なし）
  const labels = new Set([meta.label]);
  while(labels.size<4){
    const cand = DATA[Math.floor(Math.random()*DATA.length)].label;
    labels.add(cand);
  }
  const choices = shuffle(Array.from(labels));

  return {meta, viewData, pickedChoice:null, choices};
}

/* ===== Map handling ===== */
let codeToEl = {}; let mapReady = false;
async function loadMap(){
  try{
    const res = await fetch("https://geolonia.github.io/japanese-prefectures/map-full.svg",{mode:"cors"});
    if(!res.ok) throw new Error("map fetch failed");
    const svg = await res.text();
    const container = document.getElementById("map");
    container.innerHTML = svg;
    container.querySelectorAll(".prefecture").forEach(el=>{
      const code = String(el.dataset.code||"").padStart(2,"0");
      codeToEl[code]=el;
    });
    mapReady=true;
    if(history[pointer]) applyMap(history[pointer]);
  }catch(e){
    const m = document.getElementById("map");
    if(m) m.textContent = "地図の読み込みに失敗しました。別ブラウザでお試しください。";
    console.error(e);
  }
}
function clearMap(){
  if(!mapReady) return;
  Object.values(codeToEl).forEach(el=>{
    el.style.removeProperty('fill');
    el.style.removeProperty('stroke');
  });
}
function applyMap(q){
  if(!mapReady||!q) return;
  clearMap();
  const n = q.viewData.length;
  const maxA = 0.9, minA = 0.35;
  q.viewData.forEach((row,i)=>{
    const code = NAME_TO_CODE[row.pref];
    const el = codeToEl[code];
    if(el){
      const alpha = (n<=1) ? maxA : (maxA - (maxA-minA) * (i/(n-1)));
      el.style.fill = `rgba(251,191,36,${alpha})`; // amber rank shade
      el.style.stroke = "#f59e0b";
    }
  });
}

/* ===== UI render ===== */

function render(q){
  const answered = !!q.pickedChoice;
  // header
  document.getElementById("prodName").textContent = answered ? q.meta.label : "？？？";
  document.getElementById("titleBox").classList.toggle("revealed", answered);
  document.getElementById("yearChip").textContent = `基準年: ${q.meta.year}`;
  document.getElementById("unitChip").textContent = `単位: ${q.meta.unit}`;
  const srcChip = document.getElementById("srcChip");
  srcChip.textContent = answered ? `出典: ${q.meta.source}` : "";
  srcChip.style.display = answered ? "inline-flex" : "none";

  // bars
  const bars = document.getElementById("bars"); bars.innerHTML = "";
  q.viewData.forEach((row)=>{
    const el = document.createElement("div");
    el.className = "bar";
    if(answered){
      // show prefecture names after answering
      el.style.gridTemplateColumns = "minmax(8em,10em) 1fr max-content";
      el.innerHTML = `<div class="lbl"><span class="lbl-text" title="${row.pref}">${row.pref}</span></div>
        <div class="track"><div class="fill" style="width:${Math.max(2,row.pct).toFixed(1)}%"></div></div>
        <div class="val">${numFmt(row.val, q.meta.id)} ${q.meta.unit}</div>`;
    }else{
      // hide prefecture names before answering (wider bars)
      el.style.gridTemplateColumns = "1fr max-content";
      el.innerHTML = `<div class="track"><div class="fill" style="width:${Math.max(2,row.pct).toFixed(1)}%"></div></div>
        <div class="val">${numFmt(row.val, q.meta.id)} ${q.meta.unit}</div>`;
    }
    bars.appendChild(el);
  });

  // choices
  const area = document.getElementById("choices"); area.innerHTML = "";
  q.choices.forEach((label)=>{
    const btn = document.createElement("button");
    btn.className = "choice-btn";
    btn.textContent = label;
    btn.addEventListener("click", ()=> answer(label));
    area.appendChild(btn);
  });
  if(answered){
    const correct = q.meta.label;
    document.querySelectorAll(".choice-btn").forEach(b=>{
      if(b.textContent === correct){ b.classList.add("correct"); }
      if(q.pickedChoice !== correct && b.textContent === q.pickedChoice){ b.classList.add("wrong"); }
      b.disabled = true;
    });
  }

  // reveal box
  const rev = document.getElementById("reveal");
  if(answered){
    rev.innerHTML = `<div style="padding:10px;border:1px dashed #e5e7eb;border-radius:8px;background:#f8fafc">
      <b>${q.pickedChoice===q.meta.label?"正解！":"不正解…"}</b>　${q.meta.label}（${q.meta.year}）<br>
      出典：${q.meta.source}
    </div>`;
    if(q.meta && q.meta.id === "SEMI_WAFER"){
      rev.innerHTML += `<div class=\"uno-point\"><h4>UNO POINT</h4><p>台湾の世界最大の半導体メーカーTSMCは熊本県菊陽に半導体工場を作りました。ここには阿蘇の豊富な水があり、空港と高速道路に近いという立地により選ばれました。</p></div>`;
    }
    if(q.meta && q.meta.id === "PAPER"){
      rev.innerHTML += `<div class=\"uno-point\"><h4>UNO POINT</h4><p>紙の原料となる木材産地がランキング上位に無いことに注目してください。静岡県は富士の豊富な湧水のため。愛媛県は日照時間の長い瀬戸内海の気候を活かして昔から和紙づくり(よく乾く)が盛んでした。東京、大阪の周辺では紙のリサイクル業が多く集まっています。</p></div>`;
    }
    if(q.meta && q.meta.id === "SHIP"){
      rev.innerHTML += `<div class=\"uno-point\"><h4>UNO POINT</h4><p>長崎や神奈川には昔から大きな軍港があります。瀬戸内海地域は雨の少ない気候が造船の屋外作業に適しています。</p></div>`;
    }
  }else{
    rev.innerHTML = "";
  }

  // map + status
  applyMap(q);
  document.getElementById("qIndex").textContent = (pointer+1);
  document.getElementById("qTotal").textContent = history.length;
  document.getElementById("score").textContent = score;
}


/* ===== controls ===== */
function answer(label){
  const q = history[pointer];
  if(q.pickedChoice) return; // already answered

  const correct = q.meta.label;
  q.pickedChoice = label;

  // mark buttons
  const buttons = Array.from(document.querySelectorAll(".choice-btn"));
  buttons.forEach(b=>{
    if(b.textContent === correct){ b.classList.add("correct"); }
    if(b.textContent === label && label !== correct){ b.classList.add("wrong"); }
    b.disabled = true;
  });

  if(label === correct) score++;

  // Re-render in answered mode to show prefecture names on bars and proper reveal/UNO POINT
  render(q);
}
function reveal(){
  const q=history[pointer];
  if(!q || q.pickedChoice) return;
  answer(q.meta.label);
}
function next(){
  window.scrollTo({top:0,behavior:'smooth'});
  if(pointer < history.length-1){ pointer++; render(history[pointer]); }
  else { const q=pickQuestion(); history.push(q); pointer=history.length-1; render(q); }
}
function prev(){
  window.scrollTo({top:0,behavior:'smooth'});
  if(pointer>0){ pointer--; render(history[pointer]); }
}

document.getElementById("nextBtn").addEventListener("click", next);
document.getElementById("prevBtn").addEventListener("click", prev);
document.getElementById("revealBtn").addEventListener("click", reveal);

/* init */
history.push(pickQuestion()); pointer=0; render(history[0]); loadMap();
</script>
</body>
</html>
